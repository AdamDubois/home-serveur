<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì• Import CSV - Mon√©tariat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background:  linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius:  8px;
            text-decoration:  none;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-link:hover {
            background:  rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom:  30px;
        }

        .step-item {
            padding: 10px 20px;
            background: #e0e0e0;
            border-radius: 20px;
            font-weight: 600;
            color: #666;
        }

        .step-item.active {
            background: #667eea;
            color: white;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-zone:hover {
            background: #e7f3ff;
            border-color: #5568d3;
        }

        .upload-zone.dragover {
            background: #e7f3ff;
            border-color: #5568d3;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 60px;
            margin-bottom:  20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display:  block;
            margin-bottom:  8px;
            color: #333;
            font-weight: 600;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size:  16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background:  #6c757d;
            color:  white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
            display: block;
        }

        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .preview-table tbody {
            max-height: 400px;
            overflow-y: auto;
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .success-message {
            background: #28a745;
            color: white;
        }

        .error-message {
            background: #dc3545;
            color:  white;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196f3;
            padding:  15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <a href="/monetariat" class="back-link">‚Üê Retour au dashboard</a>

    <div class="container">
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>

        <div class="card">
            <h1>üì• Import CSV</h1>
            <p class="subtitle">Importez vos transactions depuis un fichier CSV</p>

            <!-- Indicateur d'√©tapes -->
            <div class="step-indicator">
                <div class="step-item active" id="step-indicator-1">1.Upload</div>
                <div class="step-item" id="step-indicator-2">2.Configuration</div>
                <div class="step-item" id="step-indicator-3">3.Aper√ßu</div>
                <div class="step-item" id="step-indicator-4">4.Import</div>
            </div>

            <!-- √âTAPE 1: Upload du fichier -->
            <div class="step active" id="step1">
                <div class="info-box">
                    <strong>‚ÑπÔ∏è Format attendu :</strong> Fichier CSV avec au minimum une colonne "Date" et une colonne "Montant".
                    <br>Exemple:  <code>Date,Description,Montant,Cat√©gorie</code>
                    <br><br><strong>Format Desjardins support√© :</strong> Date de l'op√©ration, CAD$, Description 1, etc.
                </div>

                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">üìÑ</div>
                    <h3>Glissez-d√©posez votre fichier CSV ici</h3>
                    <p>ou cliquez pour s√©lectionner un fichier</p>
                    <input type="file" id="fileInput" accept=".csv" style="display: none;">
                </div>
            </div>

            <!-- √âTAPE 2: Configuration -->
            <div class="step" id="step2">
                <h2>Configuration de l'import</h2>

                <div class="form-group">
                    <label>Compte de destination *</label>
                    <select id="compteSelect" required></select>
                </div>

                <div class="form-group">
                    <label>Type de transactions *</label>
                    <select id="typeSelect" required>
                        <option value="auto">üîÑ Automatique (selon le signe du montant)</option>
                        <option value="depense">üí∏ D√©penses uniquement</option>
                        <option value="revenu">üí∞ Revenus uniquement</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Mode de paiement par d√©faut *</label>
                    <select id="paymentMethodSelect" required></select>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Mapping des colonnes</h3>
                <p style="color: #666; margin-bottom:   20px;">Associez les colonnes de votre CSV aux champs requis</p>

                <div class="form-group">
                    <label>Colonne "Date" *</label>
                    <select id="dateColumn" required></select>
                </div>

                <!-- Zone de montant conditionnelle -->
                <div id="montantSimpleGroup" class="form-group">
                    <label>Colonne "Montant" *</label>
                    <select id="montantColumn" required></select>
                </div>

                <!-- Zone CAD$ + USD$ d√©tect√©e -->
                <div id="montantMultiGroup" class="form-group" style="display: none;">
                    <label>Colonnes de montants d√©tect√©es</label>
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border: 2px solid #2196f3;">
                        <p style="margin-bottom: 10px;"><strong>‚úÖ CAD$</strong> et <strong>‚úÖ USD$</strong> d√©tect√©s automatiquement</p>
                        <p style="color: #666; font-size: 13px;">Les montants seront fusionn√©s automatiquement (priorit√© CAD$, conversion USD$ si n√©cessaire)</p>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label>Taux de conversion USD ‚Üí CAD</label>
                        <input type="number" id="tauxUsdCad" step="0.01" min="0.01" value="1.35" 
                               style="width: 150px;" placeholder="Ex: 1.35">
                        <small style="display: block; color: #666; margin-top:  5px;">
                            üí° Ce taux sera appliqu√© aux transactions en USD$
                        </small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Colonne "Description" (optionnel)</label>
                    <select id="descriptionColumn">
                        <option value="">-- Aucune --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Colonne "Cat√©gorie" (optionnel)</label>
                    <select id="categorieColumn">
                        <option value="">-- Aucune --</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Retour</button>
                    <button class="btn btn-primary" onclick="goToStep(3)">Aper√ßu ‚Üí</button>
                </div>
            </div>

            <!-- √âTAPE 3: Aper√ßu -->
            <div class="step" id="step3">
                <h2>Aper√ßu des donn√©es</h2>
                <p style="color: #666; margin-bottom:  20px;">V√©rifiez que les donn√©es sont correctement mapp√©es</p>

                <div id="previewContainer"></div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Retour</button>
                    <button class="btn btn-primary" onclick="executeImport()">Importer ‚Üí</button>
                </div>
            </div>

            <!-- √âTAPE 4: R√©sultat -->
            <div class="step" id="step4">
                <div id="resultContainer"></div>
                <button class="btn btn-primary" onclick="location.reload()">Nouvel import</button>
            </div>
        </div>
    </div>

    <script>
        let csvData = null;
        let parsedData = null;
        let accounts = [];
        let paymentMethods = [];

        // Charger les donn√©es
        async function loadData() {
            const accountsRes = await fetch('/monetariat/api/accounts');
            accounts = await accountsRes.json();
            populateAccounts();

            const methodsRes = await fetch('/monetariat/api/payment-methods');
            paymentMethods = await methodsRes.json();
            populatePaymentMethods();
        }

        function populateAccounts() {
            const select = document.getElementById('compteSelect');
            select.innerHTML = '';
            accounts.forEach(acc => {
                select.add(new Option(acc.nom, acc.id));
            });
        }

        function populatePaymentMethods() {
            const select = document.getElementById('paymentMethodSelect');
            select.innerHTML = '';
            paymentMethods.forEach(method => {
                select.add(new Option(method.nom, method.id));
            });
        }

        // Upload zone
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        async function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showError('Veuillez s√©lectionner un fichier CSV');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/monetariat/api/import/parse', {
                    method: 'POST',
                    body:  formData
                });

                if (!res.ok) {
                    const error = await res.json();
                    showError(error.error);
                    return;
                }

                parsedData = await res.json();
                csvData = parsedData.all_data;

                // Peupler les s√©lecteurs de colonnes
                populateColumnSelectors(parsedData.columns);

                // Auto-d√©tecter les colonnes
                autoDetectColumns(parsedData.columns);

                showSuccess(`‚úÖ Fichier charg√©:  ${parsedData.total_rows} lignes d√©tect√©es`);
                goToStep(2);

            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur lors de la lecture du fichier');
            }
        }

        function populateColumnSelectors(columns) {
            const selectors = ['dateColumn', 'montantColumn', 'descriptionColumn', 'categorieColumn'];
            
            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                select.innerHTML = selectorId.includes('description') || selectorId.includes('categorie') 
                    ? '<option value="">-- Aucune --</option>' 
                    : '';
                
                columns.forEach(col => {
                    select.add(new Option(col, col));
                });
            });
        }

        function autoDetectColumns(columns) {
            // D√©tection automatique de la colonne date
            const datePatterns = ['date', 'Date de l\'op√©ration', 'Date'];
            for (const pattern of datePatterns) {
                const match = columns.find(col => col.toLowerCase().includes(pattern.toLowerCase()));
                if (match) {
                    document.getElementById('dateColumn').value = match;
                    break;
                }
            }

            // ========== D√âTECTION CAD$ ET USD$ ==========
            const hasCad = columns.includes('CAD$');
            const hasUsd = columns.includes('USD$');

            if (hasCad && hasUsd) {
                // Mode multi-devises :  cacher le s√©lecteur simple, afficher la zone CAD$/USD$
                document.getElementById('montantSimpleGroup').style.display = 'none';
                document.getElementById('montantMultiGroup').style.display = 'block';
                document.getElementById('montantColumn').required = false;
                
                // Charger le taux sauvegard√© (localStorage)
                const savedTaux = localStorage.getItem('monetariat_taux_usd_cad');
                if (savedTaux) {
                    document.getElementById('tauxUsdCad').value = savedTaux;
                }
            } else {
                // Mode simple : afficher le s√©lecteur de montant
                document.getElementById('montantSimpleGroup').style.display = 'block';
                document.getElementById('montantMultiGroup').style.display = 'none';
                document.getElementById('montantColumn').required = true;

                // D√©tection automatique de la colonne montant unique
                const montantPatterns = ['CAD$', 'USD$', 'montant', 'amount', 'Montant'];
                for (const pattern of montantPatterns) {
                    const match = columns.find(col => col === pattern || col.toLowerCase().includes(pattern.toLowerCase()));
                    if (match) {
                        document.getElementById('montantColumn').value = match;
                        break;
                    }
                }
            }

            // D√©tection automatique de la description (priorit√© Description 1)
            const descPatterns = ['Description 1', 'Description', 'description', 'Libell√©'];
            for (const pattern of descPatterns) {
                const match = columns.find(col => col === pattern || col.toLowerCase().includes(pattern.toLowerCase()));
                if (match) {
                    document.getElementById('descriptionColumn').value = match;
                    break;
                }
            }
        }

        function goToStep(stepNumber) {
            // Validation avant de passer √† l'√©tape suivante
            if (stepNumber === 3) {
                const compteOk = document.getElementById('compteSelect').value;
                const dateOk = document.getElementById('dateColumn').value;
                
                // V√©rifier si on a un montant (simple ou multi)
                const montantSimpleVisible = document.getElementById('montantSimpleGroup').style.display !== 'none';
                const montantOk = montantSimpleVisible 
                    ? document.getElementById('montantColumn').value 
                    : true;  // Si multi-devises, pas besoin de s√©lecteur
                
                if (!compteOk || !dateOk || ! montantOk) {
                    showError('Veuillez remplir tous les champs obligatoires');
                    return;
                }
                
                // Sauvegarder le taux USD/CAD si visible
                const montantMultiVisible = document.getElementById('montantMultiGroup').style.display !== 'none';
                if (montantMultiVisible) {
                    const taux = document.getElementById('tauxUsdCad').value;
                    localStorage.setItem('monetariat_taux_usd_cad', taux);
                }
                
                generatePreview();
            }

            // Cacher toutes les √©tapes
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.querySelectorAll('.step-item').forEach(item => item.classList.remove('active'));

            // Afficher l'√©tape demand√©e
            document.getElementById(`step${stepNumber}`).classList.add('active');
            document.getElementById(`step-indicator-${stepNumber}`).classList.add('active');
        }

        function generatePreview() {
            const dateCol = document.getElementById('dateColumn').value;
            const descCol = document.getElementById('descriptionColumn').value;
            const catCol = document.getElementById('categorieColumn').value;
            const typeSelect = document.getElementById('typeSelect').value;

            // D√©terminer si on est en mode multi-devises
            const isMultiCurrency = document.getElementById('montantMultiGroup').style.display !== 'none';
            const tauxUsdCad = isMultiCurrency ? parseFloat(document.getElementById('tauxUsdCad').value) : 1.35;

            const previewContainer = document.getElementById('previewContainer');
            
            let html = `
                <table class="preview-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Montant</th>
                            ${catCol ? '<th>Cat√©gorie</th>' : ''}
                            <th>Type d√©tect√©</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const preview = csvData.slice(0, 10);

            preview.forEach(row => {
                let montant, devise;

                if (isMultiCurrency) {
                    // Mode CAD$ + USD$
                    const montantCadStr = row['CAD$'] || '0';
                    const montantUsdStr = row['USD$'] || '0';
                    
                    const montantCad = parseFloat(montantCadStr.replace(',', '.').replace(' ', '').replace('$', ''));
                    const montantUsd = parseFloat(montantUsdStr.replace(',', '.').replace(' ', '').replace('$', ''));
                    
                    if (montantCad !== 0) {
                        montant = montantCad;
                        devise = 'CAD';
                    } else if (montantUsd !== 0) {
                        montant = montantUsd * tauxUsdCad;
                        devise = `USD (${montantUsd.toFixed(2)} USD √ó ${tauxUsdCad} = ${montant.toFixed(2)} CAD)`;
                    } else {
                        montant = 0;
                        devise = '';
                    }
                } else {
                    // Mode simple (une seule colonne)
                    const montantCol = document.getElementById('montantColumn').value;
                    const montantStr = row[montantCol] || '0';
                    montant = parseFloat(montantStr.replace(',', '.').replace(' ', '').replace('$', ''));
                    devise = '';
                }
                
                let type, typeClass;
                if (typeSelect === 'auto') {
                    type = montant < 0 ? 'üí∏ D√©pense' : 'üí∞ Revenu';
                    typeClass = montant < 0 ?  'color:  #dc3545' : 'color: #28a745';
                } else if (typeSelect === 'depense') {
                    type = 'üí∏ D√©pense';
                    typeClass = 'color: #dc3545';
                } else {
                    type = 'üí∞ Revenu';
                    typeClass = 'color:  #28a745';
                }

                html += `
                    <tr>
                        <td>${row[dateCol]}</td>
                        <td>${descCol ?  row[descCol] : '-'}</td>
                        <td style="${typeClass}">
                            <strong>${Math.abs(montant).toFixed(2)} $</strong>
                            ${devise && devise !== 'CAD' ? `<br><small style="color: #666;">${devise}</small>` : ''}
                        </td>
                        ${catCol ? `<td>${row[catCol] || '-'}</td>` : ''}
                        <td style="${typeClass}"><strong>${type}</strong></td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <p style="margin-top: 15px; color: #666; text-align: center;">
                    Aper√ßu des 10 premi√®res lignes sur ${csvData.length} au total
                </p>
            `;

            previewContainer.innerHTML = html;
        }

        async function executeImport() {
            const compteId = parseInt(document.getElementById('compteSelect').value);
            const typeSelect = document.getElementById('typeSelect').value;
            const paymentMethodId = parseInt(document.getElementById('paymentMethodSelect').value);

            // D√©terminer si on est en mode multi-devises
            const isMultiCurrency = document.getElementById('montantMultiGroup').style.display !== 'none';
            const tauxUsdCad = isMultiCurrency ? parseFloat(document.getElementById('tauxUsdCad').value) : 1.35;

            const mapping = {
                date: document.getElementById('dateColumn').value,
                montant: isMultiCurrency ? 'CAD$' : document.getElementById('montantColumn').value,
                description: document.getElementById('descriptionColumn').value || null,
                categorie: document.getElementById('categorieColumn').value || null,
                is_multi_currency: isMultiCurrency,
                taux_usd_cad: tauxUsdCad
            };

            try {
                const res = await fetch('/monetariat/api/import/execute', {
                    method: 'POST',
                    headers:  { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        compte_id: compteId,
                        type:  typeSelect,
                        mode_paiement_id: paymentMethodId,
                        mapping: mapping,
                        rows: csvData
                    })
                });

                const result = await res.json();

                if (result.success) {
                    displayResult(result);
                    goToStep(4);
                } else {
                    showError(result.error || 'Erreur lors de l\'import');
                }

            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur lors de l\'import');
            }
        }

        function displayResult(result) {
            const container = document.getElementById('resultContainer');
            
            let html = `
                <div style="text-align: center; padding: 40px 0;">
                    <div style="font-size: 80px; margin-bottom: 20px;">‚úÖ</div>
                    <h2 style="color: #28a745; margin-bottom: 20px;">Import r√©ussi !</h2>
                    <p style="font-size: 18px; color: #333;">
                        <strong>${result.imported}</strong> transactions import√©es sur <strong>${result.total}</strong>
                    </p>
            `;

            if (result.errors && result.errors.length > 0) {
                html += `
                    <div style="margin-top: 30px; background: #fff3cd; padding: 20px; border-radius: 10px; text-align: left;">
                        <h3 style="color:  #856404; margin-bottom: 15px;">‚ö†Ô∏è Erreurs (${result.errors.length})</h3>
                        <ul style="color: #856404;">
                `;
                result.errors.slice(0, 5).forEach(err => {
                    html += `<li>Ligne ${err.line}: ${err.error}</li>`;
                });
                if (result.errors.length > 5) {
                    html += `<li>...et ${result.errors.length - 5} autres erreurs</li>`;
                }
                html += `</ul></div>`;
            }

            html += `</div>`;
            container.innerHTML = html;
        }

        function showSuccess(text) {
            const msg = document.getElementById('successMessage');
            msg.textContent = text;
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
            }, 3000);
        }

        function showError(text) {
            const msg = document.getElementById('errorMessage');
            msg.textContent = '‚ùå ' + text;
            msg.style.display = 'block';
            window.scrollTo(0, 0);
            setTimeout(() => {
                msg.style.display = 'none';
            }, 5000);
        }

        // Charger les donn√©es au d√©marrage
        loadData();
    </script>
</body>
</html>